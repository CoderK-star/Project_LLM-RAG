<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a1b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ごみ収集AI">
<meta name="description" content="ごみ収集アシスタント - AIでごみの分別をサポート">
<link rel="icon" href="icons/icon-192.png">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>ごみ収集アシスタント</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="web.js"></script>
</head>
<body>

  <div class="main-sidebar">
    <div class="sidebar-top">
      <div class="setting-btn" id="goHome">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <div class="tooltip-panel">ホーム</div>
      </div>
      <div class="setting-btn" id="newChat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <div class="tooltip-panel">新しいチャット</div>
      </div>
      <div class="setting-btn" id="openSettings">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <div class="tooltip-panel">設定</div>
      </div>
      
      <div class="setting-btn" id="openHistoryDashboard">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        <div class="tooltip-panel">会話履歴</div>
      </div>
    </div>
      <div class="setting-btn" id="exportData">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        <div class="tooltip-panel">データをエクスポートする</div>
      </div>
      <div class="setting-btn" id="toggleTheme">
        <svg class="theme-sun hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="theme-moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <div class="tooltip-panel">テーマ切替</div>
      </div>
    </div>
  </div>

  <!-- モバイル用ボトムナビゲーション -->
  <div class="mobile-nav">
    <button class="mobile-nav-btn" id="mobileHome">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      <span>ホーム</span>
    </button>
    <button class="mobile-nav-btn" id="mobileNewChat">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      <span>新規</span>
    </button>
    <button class="mobile-nav-btn" id="mobileHistory">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
      <span>履歴</span>
    </button>
    <button class="mobile-nav-btn" id="mobileSettings">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09"></path></svg>
      <span>設定</span>
    </button>
    <button class="mobile-nav-btn" id="mobileTheme">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      <span>テーマ</span>
    </button>
  </div>

  <div class="bg-decorator"></div>
  <div class="bg-silhouette"></div>

  <!-- 装飾用の十字線 -->
  <div class="crosshair crosshair-tl"></div>
  <div class="crosshair crosshair-tr"></div>
  <div class="crosshair crosshair-bl"></div>
  <div class="crosshair crosshair-br"></div>

  <!-- 履歴ダッシュボードUI -->
  <div class="ui-container hidden" id="historyDashboard">
    <div class="top-header">
      <div class="title-group-mini">
        <h1 class="brand-main text-title-lg">会話セッション</h1>
        <p class="text-subtitle">会話セッションを管理・確認します</p>
      </div>
      <button class="close-btn" id="closeDashboard">チャットに戻る</button>
    </div>

    <div class="dashboard-controls">
      <div class="search-box">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="historySearch" class="search-input" placeholder="会話を検索...">
      </div>
      
      <button class="icon-btn-outline" id="refreshHistory">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
      </button>

      <select id="filterDatabase" class="select-outline">
        <option>すべてのセッション</option>
      </select>

      <select id="sortOrder" class="select-outline">
        <option>昇順</option>
        <option>降順</option>
      </select>

      <button class="action-btn" id="exportAllHistory">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        データをエクスポート
      </button>

      <button class="action-btn-primary" id="reindexAll">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>
        全セッションを最適化
      </button>
    </div>

    <div id="dashboardContent" class="dashboard-content">
      <div id="emptyState" class="empty-state">
        <svg class="empty-state-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <h3 class="empty-state-title">セッションが見つかりません</h3>
        <p class="text-small">検索やフィルター条件を調整してみてください</p>
      </div>
      <div id="sessionGrid" class="session-grid"></div>
    </div>
  </div>

  <!-- 履歴詳細 -->
  <div class="ui-container hidden" id="historyUI">
    <div class="top-header">
      <div class="title-group-mini">
        <h1 class="brand-main text-title-md">セッション詳細 <span class="badge">SESSION_VIEW</span></h1>
      </div>
      <button class="close-btn" id="closeHistory">閉じる</button>
    </div>
    
    <div class="settings-content history-details-panel" id="historyDetails"></div>
    
    <div class="btn-row">
      <button id="deleteSession" class="save-btn action-btn-danger w-auto">セッションを削除</button>
      <button id="resumeChat" class="save-btn w-auto">このチャットを再開</button>
    </div>
  </div>

  <div class="ui-container" id="mainUI">
    
    <!-- ヘッダー -->
    <div class="top-header">
      <div class="title-group-mini">
        <h1 class="brand-main text-title-md">ごみ収集アシスタント <span class="badge">GCA</span></h1>
      </div>
      <div class="connection-status" id="connectionStatus">
        接続確認中...
      </div>
    </div>

    <!-- メインインターフェース -->
    <div class="chat-wrapper">
      
      <!-- 左: ステータス -->
      <div class="left-side">
        <div class="status-item">
          <div class="status-indicator">LLM</div>
          <div class="status-content">
            <span class="status-label">モデル</span>
            <span class="status-value" id="statusModelName">読み込み中...</span>
          </div>
        </div>
        <div class="status-item">
          <div class="status-indicator">検索</div>
          <div class="status-content">
            <span class="status-label">エンジン</span>
            <span class="status-value" id="statusEngineMode">不明</span>
          </div>
        </div>
        <div class="source-panel">
          <div class="source-panel-header">ソース</div>
          <div id="sourceList" class="source-panel-content">
            (クエリ待機中...)
          </div>
        </div>
        <div class="notice-box">
          注意: AIの回答は上記のソースに基づいて生成されます。
        </div>
      </div>

      <!-- Resize Handle -->
      <div class="resizer" id="resizer"></div>

      <!-- 中央: チャット -->
      <div class="chat-view">
        <div class="chat-log" id="chatLog"></div>

      <div class="input-bar-container">
        <div id="imagePreviewContainer" class="image-preview hidden">
           <img id="previewImg" src="" alt="preview">
           <div class="remove-image" id="removeImage">&times;</div>
        </div>
        <div class="input-bar">
          <input type="file" id="imageInput" accept="image/*" style="display: none;">
          
          <button id="voiceInputBtn" class="icon-btn" title="音声入力">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
          </button>
          
          <button id="imageBtn" class="icon-btn" title="画像をアップロード">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          </button>
          
          <button id="locationBtn" class="icon-btn" title="位置情報を使用">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          </button>

          <textarea placeholder="メッセージを入力..." id="userInput" rows="1"></textarea>
          <button id="sendBtn">送信</button>
        </div>
      </div>
      </div>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="modal hidden">
        <div class="modal-content">
            <h3>位置情報の使用確認</h3>
            <p>より正確な回答を提供するために、位置情報を使用しますか？</p>
            <div id="mapPreview" style="height: 150px; width: 100%; margin: 10px 0; background: #ddd; display:none;"></div>
            <div class="modal-actions">
                <button id="denyLocation" class="btn-secondary">許可しない</button>
                <button id="allowLocation" class="btn-primary">許可する</button>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <div class="bottom-status">
      <div class="status-row">
        <div class="status-dot"></div>
        <div class="text-xxs text-mono" id="footerStatus"></div>
      </div>
      <div class="region-selector">
        <div class="menu-icon">&#8803;</div>
      </div>
    </div>

  </div>

  <div class="ui-container hidden" id="settingsUI">
    <div class="top-header">
      <div class="title-group-mini">
        <h1 class="brand-main text-title-md">設定 <span class="badge">SYSTEM_CONFIG</span></h1>
      </div>
      <button class="close-btn" id="closeSettings">閉じる</button>
    </div>

    <div class="settings-content">
      <div class="settings-section">
        <h2 class="section-title">LLMエンジン設定</h2>
        <div class="config-grid">
          <div class="config-item">
            <label>バックエンドURL</label>
            <input type="text" placeholder="空欄 = 同一オリジン / https://your-app.onrender.com" id="apiBaseUrl">
          </div>
          <div class="config-item">
            <label>モデルタイプ</label>
            <select id="modelType">
              <option value="ollama">Ollama (ローカル)</option>
              <option value="openai">OpenAI (クラウド)</option>
            </select>
          </div>
          <div class="config-item">
            <label>モデル名</label>
            <input type="text" placeholder="qwen2.5:3b / gpt-4o" id="modelNameInput">
          </div>
          <div class="config-item">
            <label>APIキー / エンドポイント</label>
            <input type="password" placeholder="sk-... / http://..." id="apiAddress">
          </div>
          <div class="config-item">
            <label>音声出力 (TTS)</label>
            <select id="ttsEnabled">
              <option value="false">オフ</option>
              <option value="true">オン (システム音声)</option>
            </select>
          </div>
          <div class="config-item">
            <div class="config-row">
              <label>温度パラメータ</label>
              <span id="tempValue" class="text-mono text-bold">0.0</span>
            </div>
            <input type="range" min="0" max="1" step="0.1" value="0.0" id="tempRange">
          </div>
        </div>
        <button class="save-btn" id="saveSettings">設定を適用</button>
      </div>
    </div>
  </div>

  <div class="version-label">
    v1.1.0
  </div>

</body>
</html>
